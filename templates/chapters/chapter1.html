<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>Chapter {{ chapter_number }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/chapter1.css' %}">
</head>
<body>
    <main>
        <div class="page-heading">
            <div class="title-block">
                <h1>Chapter {{ chapter_number }}: Learning {{ chapter_letter }}</h1>
                <p>Master the fundamentals of {{ chapter_letter }} in ASL</p>
            </div>
            <a class="back-link" href="{% url 'level' %}" aria-label="Back to level path">← Back to Path</a>
        </div>

        <section class="chapter-content">
            <div class="syllabus-intro">
                <h2>Chapter Overview</h2>
                <p>Start with the ASL alphabet, core responses, and a few everyday phrases. Hover to preview, focus to practice.</p>
            </div>

            <h3 style="color: var(--text); margin: 24px 0 12px; font-size: 18px;">Alphabet (A–Z)</h3>
            <div class="lessons-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                {% for item in chapter_resources.alphabet %}
                <article class="lesson-card letter-card" tabindex="0">
                    <div class="lesson-number">{{ item.title }}</div>
                    <h4 class="lesson-title">Fingerspell {{ item.title }}</h4>
                    <div class="letter-pop">
                        {% if item.video %}
                        <video controls width="100%" style="border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background:#000;">
                            <source src="{{ item.video }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <p class="lesson-desc" style="margin-top:8px;">Video: SignASL ({{ item.title }}).</p>
                        {% else %}
                        <p class="lesson-desc" style="margin:0;">Video unavailable right now.</p>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
            </div>

            <h3 style="color: var(--text); margin: 24px 0 12px; font-size: 18px;">Core Responses</h3>
            <div class="lessons-grid">
                {% for item in chapter_resources.responses %}
                <article class="lesson-card">
                    <div class="lesson-number">{{ forloop.counter }}</div>
                    <h4 class="lesson-title">{{ item.title }}</h4>
                    {% if item.video %}
                    <video controls width="100%" style="border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); background:#000;">
                        <source src="{{ item.video }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <p class="lesson-desc" style="margin-top:8px;">SignASL clip.</p>
                    {% else %}
                    <p class="lesson-desc" style="margin-top:8px;">Video unavailable right now.</p>
                    {% endif %}
                </article>
                {% endfor %}
            </div>

            <h3 style="color: var(--text); margin: 24px 0 12px; font-size: 18px;">Example Phrases</h3>
            <div class="lessons-grid">
                {% for phrase in chapter_resources.phrases %}
                <article class="lesson-card phrase-card" tabindex="0"
                    {% if phrase.segment_urls %}
                        data-playlist="{{ phrase.segment_urls|join:'|' }}"
                    {% endif %}
                >
                    <div class="lesson-number">{{ forloop.counter }}</div>
                    <h4 class="lesson-title">{{ phrase.title }}</h4>
                    {% if phrase.video %}
                    <video controls width="100%" style="border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); background:#000;">
                        <source src="{{ phrase.video }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <p class="lesson-desc" style="margin-top:8px;">SignASL clip.</p>
                    <script src="{% static 'js/chapter1.js' %}" defer></script>

                const playNow = () => {
                    clearTimeout(timer);
                    video.muted = true;
                    video.play().catch(() => {});
                };

                const stopAndReset = () => {
                    clearTimeout(timer);
                    video.pause();
                    video.currentTime = 0;
                };

                video.addEventListener('ended', startLoop);
                card.addEventListener('mouseenter', playNow);
                card.addEventListener('mouseleave', stopAndReset);
                card.addEventListener('focus', playNow);
                card.addEventListener('blur', stopAndReset);
            });
        })();

        // Sequential phrase playback when a full phrase video is missing
        (function () {
            const phraseCards = document.querySelectorAll('.phrase-card');
            phraseCards.forEach((card) => {
                const playlistAttr = card.getAttribute('data-playlist');
                if (!playlistAttr) return;
                const sources = playlistAttr.split('|').filter(Boolean);
                if (!sources.length) return;

                const player = card.querySelector('.phrase-player video');
                if (!player) return;

                let idx = 0;
                let timer = null;

                const playIndex = (i) => {
                    idx = i % sources.length;
                    player.src = sources[idx];
                    player.load();
                    player.muted = true; // allow autoplay on hover/focus
                    player.play().catch(() => {});
                };

                const onEnded = () => {
                    clearTimeout(timer);
                    timer = setTimeout(() => {
                        playIndex(idx + 1);
                    }, 2000);
                };

                const start = () => {
                    clearTimeout(timer);
                    playIndex(0);
                };

                const stop = () => {
                    clearTimeout(timer);
                    player.pause();
                    player.currentTime = 0;
                };

                player.addEventListener('ended', onEnded);
                card.addEventListener('mouseenter', start);
                card.addEventListener('mouseleave', stop);
                card.addEventListener('focus', start);
                card.addEventListener('blur', stop);
            });
        })();
    </script>
</body>
</html>
