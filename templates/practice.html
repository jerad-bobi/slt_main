<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ASL Translator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --bg-accent: linear-gradient(120deg, #0b1624, #111b2c);
            --card: #131a24;
            --card-strong: #192233;
            --line: #4fd1c5;
            --line-soft: rgba(79, 209, 197, 0.25);
            --text: #f7f9fc;
            --muted: #9fb3c8;
            --shadow: 0 12px 45px rgba(0, 0, 0, 0.35);
            --radius: 14px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text);
            background: radial-gradient(circle at 20% 20%, rgba(79, 209, 197, 0.08), transparent 28%),
                        radial-gradient(circle at 80% 10%, rgba(138, 215, 255, 0.07), transparent 25%),
                        var(--bg);
        }

        main {
            padding: 28px 18px 140px;
            width: min(1100px, 100%);
            margin: 0 auto;
        }

        .page-heading {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .title-block h1 {
            margin: 0;
            font-size: clamp(26px, 3vw, 36px);
            letter-spacing: -0.02em;
        }

        .title-block p {
            margin: 6px 0 0;
            color: var(--muted);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 999px;
            padding: 10px 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-weight: 600;
            text-decoration: none;
            transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
        }

        .pill:hover { transform: translateY(-2px); border-color: rgba(255, 255, 255, 0.18); box-shadow: var(--shadow); }
        .pill:focus-visible { outline: 2px solid #4fd1c5; outline-offset: 3px; }

        .translator-shell {
            position: relative;
            background: var(--bg-accent);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            padding: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .lang-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .select-pill {
            flex: 1;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: var(--card);
            color: var(--text);
            font-weight: 600;
            text-align: center;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }

        .swap-btn {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: var(--card-strong);
            color: var(--text);
            font-weight: 700;
            cursor: pointer;
            transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
        }

        .swap-btn:hover { transform: rotate(180deg); background: var(--card); border-color: rgba(255, 255, 255, 0.22); }
        .swap-btn:focus-visible { outline: 2px solid #4fd1c5; outline-offset: 3px; }

        .panes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 12px;
        }

        .pane {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius);
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pane label {
            font-size: 14px;
            color: var(--muted);
            letter-spacing: 0.02em;
        }

        textarea {
            width: 100%;
            min-height: 160px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: var(--card-strong);
            color: var(--text);
            padding: 12px;
            font-size: 16px;
            resize: vertical;
        }

        textarea:focus-visible { outline: 2px solid #4fd1c5; outline-offset: 2px; }

        .output-box {
            min-height: 160px;
            border-radius: 12px;
            border: 1px dashed rgba(255, 255, 255, 0.12);
            background: var(--card-strong);
            color: var(--text);
            padding: 12px;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .camera-video {
            width: 100%;
            min-height: 220px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: #000;
            object-fit: cover;
        }

        .chips { display: flex; flex-wrap: wrap; gap: 6px; }

        .chip {
            padding: 6px 10px;
            border-radius: 10px;
            background: rgba(79, 209, 197, 0.14);
            border: 1px solid rgba(79, 209, 197, 0.45);
            color: var(--text);
            font-size: 13px;
        }

        .chip.active {
            background: linear-gradient(135deg, #4fd1c5, #8ad7ff);
            color: #0b1624;
            border-color: rgba(79, 209, 197, 0.75);
            font-weight: 700;
        }

        .hidden { display: none !important; }

        .actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: linear-gradient(135deg, #4fd1c5, #8ad7ff);
            color: #0b1624;
            font-weight: 700;
            cursor: pointer;
            transition: transform 120ms ease, filter 120ms ease;
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            border-color: rgba(255, 255, 255, 0.18);
        }

        .btn:hover { transform: translateY(-2px); filter: brightness(1.05); }
        .btn:focus-visible { outline: 2px solid #4fd1c5; outline-offset: 3px; }

        .hint { color: var(--muted); font-size: 13px; margin: 0; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(13, 17, 23, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px 12px;
            backdrop-filter: blur(10px);
        }

        .bottom-nav a {
            text-decoration: none;
            color: var(--text);
            text-align: center;
            flex: 0 0 auto;
            font-size: 16px;
            padding: 8px 10px;
            border-radius: 10px;
            transition: background 120ms ease, transform 120ms ease;
        }

        .bottom-nav a:hover { background: rgba(255, 255, 255, 0.06); transform: translateY(-2px); }
        .bottom-nav a:focus-visible { outline: 2px solid #4fd1c5; outline-offset: 4px; }

        @media (max-width: 720px) {
            main { padding: 22px 14px 140px; }
            .page-heading { flex-direction: column; align-items: flex-start; }
            .lang-row { flex-direction: column; }
            .swap-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <main>
        <div class="page-heading">
            <div class="title-block">
                <h1>ASL Translator</h1>
                <p>Text-to-sign or sign-to-text with one tap.</p>
            </div>
            <a class="pill" href="#translator" aria-label="Jump to translator">Open Translator</a>
        </div>

        <section id="translator" class="translator-shell" aria-label="Translator">
            <div class="lang-row">
                <div id="fromLang" class="select-pill" aria-live="polite">English (Text)</div>
                <button id="swapBtn" class="swap-btn" aria-label="Swap languages">⇄</button>
                <div id="toLang" class="select-pill" aria-live="polite">ASL (Sign)</div>
            </div>

            <div class="panes">
                <div class="pane">
                    <label id="sourceLabel" for="sourceInput">Enter text</label>
                    <textarea id="sourceInput" placeholder="Type something to translate"></textarea>
                    <p id="sourceHint" class="hint">Supports short phrases. Translation here is a demo placeholder.</p>
                    <div id="cameraBox" class="output-box hidden">
                        <span class="muted" style="color: var(--muted);">Camera preview will appear here for ASL capture.</span>
                    </div>
                </div>
                <div class="pane">
                    <label id="targetLabel">Sign output</label>
                    <div id="targetBox" class="output-box">
                        <span class="muted" style="color: var(--muted);">Your translation will appear here.</span>
                    </div>
                </div>
            </div>

            <div class="actions" style="margin-top: 14px;">
                <button id="translateBtn" class="btn">Translate</button>
                <button id="clearBtn" class="btn secondary">Clear</button>
            </div>
        </section>
    </main>

    <nav class="bottom-nav" aria-label="Primary">
        <a href="{% url 'level' %}">Level Page</a>
        <a href="{% url 'practice' %}">Practice Page</a>
        <a href="{% url 'home' %}">Home Page</a>
        <a href="{% url 'dictionary' %}">Dictionary Page</a>
        <a href="{% url 'profile' %}">Profile</a>
    </nav>

    <script>
        (function () {
            const fromEl = document.getElementById('fromLang');
            const toEl = document.getElementById('toLang');
            const swapBtn = document.getElementById('swapBtn');
            const source = document.getElementById('sourceInput');
            const targetBox = document.getElementById('targetBox');
            const translateBtn = document.getElementById('translateBtn');
            const clearBtn = document.getElementById('clearBtn');
            const sourceLabel = document.getElementById('sourceLabel');
            const sourceHint = document.getElementById('sourceHint');
            const targetLabel = document.getElementById('targetLabel');
            const cameraBox = document.getElementById('cameraBox');

            let mediaStream = null;
            let cameraVideoEl = null;

            let mode = 'text-to-sign'; // or 'sign-to-text'

            function stopCamera() {
                if (cameraVideoEl) {
                    cameraVideoEl.srcObject = null;
                    cameraVideoEl = null;
                }
                if (mediaStream) {
                    mediaStream.getTracks().forEach((t) => t.stop());
                    mediaStream = null;
                }
            }

            function renderPlaceholder() {
                stopCamera();
                cameraBox.classList.add('hidden');
                source.classList.remove('hidden');
                sourceHint.classList.remove('hidden');
                targetBox.innerHTML = '<span class="muted" style="color: var(--muted);">Your translation will appear here.</span>';
            }

            async function renderCameraView(message) {
                source.classList.add('hidden');
                sourceHint.classList.add('hidden');
                cameraBox.classList.remove('hidden');
                cameraBox.innerHTML = `
                    <div style="color: var(--muted); font-size: 13px;">Camera preview for ASL capture.</div>
                    ${message ? `<div style="color: var(--muted); font-size: 12px;">${message}</div>` : ''}
                `;

                cameraVideoEl = document.createElement('video');
                cameraVideoEl.className = 'camera-video';
                cameraVideoEl.setAttribute('playsinline', '');
                cameraVideoEl.setAttribute('autoplay', '');
                cameraVideoEl.muted = true;
                cameraBox.appendChild(cameraVideoEl);

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    cameraBox.innerHTML = '<span class="muted" style="color: var(--muted);">Camera not supported in this browser.</span>';
                    return;
                }

                try {
                    mediaStream = mediaStream || await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                    cameraVideoEl.srcObject = mediaStream;
                    await cameraVideoEl.play().catch(() => {});
                } catch (err) {
                    cameraBox.innerHTML = `<span class="muted" style="color: var(--muted);">Camera unavailable: ${err.message || err}</span>`;
                }
            }

            function setMode(newMode) {
                mode = newMode;
                if (mode === 'text-to-sign') {
                    fromEl.textContent = 'English (Text)';
                    toEl.textContent = 'ASL (Sign)';
                    source.placeholder = 'Type something to translate';
                    sourceLabel.textContent = 'Enter text';
                    targetLabel.textContent = 'Sign output';
                    renderPlaceholder();
                } else {
                    fromEl.textContent = 'ASL (Sign)';
                    toEl.textContent = 'English (Text)';
                    source.placeholder = 'Describe or paste sign keywords';
                    sourceLabel.textContent = 'Show your ASL sign to the camera';
                    targetLabel.textContent = 'Text output';
                    renderCameraView('Grant camera access to stream your signs.');
                }
            }

            function cleanWords(text) {
                return text
                    .split(/\s+/)
                    .map((w) => w.replace(/^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$/g, ''))
                    .filter(Boolean)
                    .slice(0, 32);
            }

            function toChips(text) {
                const words = cleanWords(text).slice(0, 12);
                if (!words.length) return '<span class="muted" style="color: var(--muted);">No content to translate.</span>';
                return '<div class="chips">' + words.map(w => `<span class="chip">${w.toUpperCase()}</span>`).join('') + '</div>';
            }

            function buildPlaylistPlayer(segments) {
                const sources = [];
                segments.forEach((s) => {
                    if (s.video) {
                        sources.push({ src: s.video, label: s.word });
                    } else if (Array.isArray(s.spelling)) {
                        s.spelling.forEach((clip, idx) => {
                            if (!clip) return;
                            const letter = (s.word && s.word[idx]) ? s.word[idx].toUpperCase() : `#${idx + 1}`;
                            sources.push({ src: clip, label: letter });
                        });
                    }
                });

                if (!sources.length) return null;

                const container = document.createElement('div');
                const labels = sources.map((s) => s.label || '');
                const chipsMarkup = labels.length
                    ? `<div class="chips playlist-chips">${labels.map((l, i) => `<span class="chip" data-idx="${i}">${l.toUpperCase()}</span>`).join('')}</div>`
                    : '';
                container.innerHTML = `
                    <div style="color: var(--muted); font-size: 13px;">SignASL word-by-word playlist:</div>
                    <video id="playlistPlayer" controls muted playsinline style="width: 100%; max-height: 360px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background:#000;"></video>
                    ${chipsMarkup}
                    <div id="nowPlaying" style="color: var(--muted); font-size: 12px;">Sequential playback with minimal gap (spells missing words).</div>
                `;

                const player = container.querySelector('#playlistPlayer');
                const chipEls = Array.from(container.querySelectorAll('.playlist-chips .chip'));
                const nowPlaying = container.querySelector('#nowPlaying');
                let idx = 0;
                let timer = null;

                const playIdx = (i) => {
                    idx = i % sources.length;
                    player.src = sources[idx].src;
                    player.load();
                    player.play().catch(() => {});

                    // Highlight current word/spelling
                    chipEls.forEach((c) => c.classList.toggle('active', Number(c.dataset.idx) === idx));
                    if (nowPlaying && labels[idx]) {
                        nowPlaying.textContent = `Now signing: ${labels[idx]}`;
                    }
                };

                const onEnded = () => {
                    clearTimeout(timer);
                    timer = setTimeout(() => playIdx(idx + 1), 150);
                };

                player.addEventListener('ended', onEnded);
                playIdx(0);

                return container;
            }

            function translate() {
                const value = source.value.trim();
                const cleanedWords = cleanWords(value);
                const wordCount = cleanedWords.length;

                if (!value || !cleanedWords.length) {
                    if (mode === 'text-to-sign') {
                        renderPlaceholder();
                    } else {
                        renderCameraView();
                        targetBox.innerHTML = '<span class="muted" style="color: var(--muted);">Your text output will appear here.</span>';
                    }
                    return;
                }

                if (mode === 'text-to-sign') {
                    targetBox.innerHTML = `
                        <div style="color: var(--muted); font-size: 13px;">Searching SignASL…</div>
                        ${toChips(value)}
                    `;

                    const cleanedPhrase = cleanedWords.join(' ');

                    fetch(`/api/asl-video/?q=${encodeURIComponent(cleanedPhrase)}`)
                        .then((resp) => resp.ok ? resp.json() : Promise.reject(resp))
                        .then((data) => {
                            const hasPhrase = data && data.video;
                            const segments = (data && data.segments) || [];
                            const allowPlaylist = !(wordCount === 1 && hasPhrase);

                            if (hasPhrase) {
                                targetBox.innerHTML = `
                                    <div style="color: var(--muted); font-size: 13px;">SignASL phrase:</div>
                                    <video controls muted playsinline style="width: 100%; max-height: 320px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background:#000;">
                                        <source src="${data.video}" type="video/mp4" />
                                        Your browser does not support the video tag.
                                    </video>
                                    <div style="color: var(--muted); font-size: 12px;">Auto-fetched from signasl.org</div>
                                `;
                            } else {
                                targetBox.innerHTML = '';
                            }

                            if (allowPlaylist && segments && segments.length) {
                                const playlist = buildPlaylistPlayer(segments);
                                if (playlist) {
                                    targetBox.appendChild(document.createElement('hr'));
                                    targetBox.appendChild(playlist);
                                }
                            }
                        })
                        .catch(() => {
                            targetBox.innerHTML = `
                                <div style="color: var(--muted); font-size: 13px;">Lookup failed.</div>
                                ${toChips(value)}
                            `;
                        });
                } else {
                    renderCameraView();
                    targetBox.innerHTML = `
                        <div style="color: var(--muted); font-size: 13px;">Demo translation (sign → text):</div>
                        <div>${value}</div>
                        <div style="color: var(--muted); font-size: 12px;">Text rendering is a placeholder.</div>
                    `;
                }
            }

            swapBtn.addEventListener('click', () => {
                setMode(mode === 'text-to-sign' ? 'sign-to-text' : 'text-to-sign');
                translate();
            });

            translateBtn.addEventListener('click', translate);

            clearBtn.addEventListener('click', () => {
                source.value = '';
                if (mode === 'text-to-sign') {
                    renderPlaceholder();
                } else {
                    renderCameraView();
                    targetBox.innerHTML = '<span class="muted" style="color: var(--muted);">Your text output will appear here.</span>';
                }
                source.focus();
            });

            setMode('text-to-sign');
        })();
    </script>
</body>
</html>
